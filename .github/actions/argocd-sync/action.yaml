name: ArgoCD Sync
description: Trigger ArgoCD sync and optionally wait for deployment

inputs:
  argocd-server:
    description: 'ArgoCD server URL (e.g., argocd.example.com)'
    required: true
  argocd-token:
    description: 'ArgoCD auth token'
    required: true
  app-name:
    description: 'ArgoCD application name'
    required: true
  wait:
    description: 'Wait for sync to complete'
    required: false
    default: 'true'
  timeout:
    description: 'Timeout for waiting in seconds'
    required: false
    default: '300'
  prune:
    description: 'Prune resources during sync'
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Install ArgoCD CLI
      shell: bash
      run: |
        # Install ArgoCD CLI if not available (when not using runner-base image)
        if ! command -v argocd &> /dev/null; then
          echo "ArgoCD CLI not found, installing..."
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 /tmp/argocd /usr/local/bin/argocd
          rm /tmp/argocd
        else
          echo "ArgoCD CLI already available"
        fi
        argocd version --client

    - name: Verify ArgoCD Credentials
      shell: bash
      env:
        ARGOCD_SERVER: ${{ inputs.argocd-server }}
        ARGOCD_AUTH_TOKEN: ${{ inputs.argocd-token }}
        ARGOCD_OPTS: "--plaintext"
      run: |
        # Validate ArgoCD Server variable and verify credentials
        if [ -z "$ARGOCD_SERVER" ]; then
          echo "ERROR: ARGOCD_SERVER is empty"
          exit 1
        fi

        # Verify credentials with gRPC-web
        echo "Verifying ArgoCD credentials..."
        argocd account get-user-info

    - name: Sync application
      shell: bash
      env:
        ARGOCD_SERVER: ${{ inputs.argocd-server }}
        ARGOCD_AUTH_TOKEN: ${{ inputs.argocd-token }}
        ARGOCD_OPTS: "--plaintext"
      run: |
        # Sync ArgoCD Application
        SYNC_ARGS=""
        if [[ "${{ inputs.prune }}" == "true" ]]; then
          SYNC_ARGS="--prune"
        fi

        echo "Syncing ArgoCD application: ${{ inputs.app-name }}"
        argocd app sync ${{ inputs.app-name }} $SYNC_ARGS

    - name: Wait for sync
      if: inputs.wait == 'true'
      shell: bash
      env:
        ARGOCD_SERVER: ${{ inputs.argocd-server }}
        ARGOCD_AUTH_TOKEN: ${{ inputs.argocd-token }}
        ARGOCD_OPTS: "--plaintext"
      run: |
        # Wait ArgoCD Application sync to finish
        echo "Waiting for sync to complete (timeout: ${{ inputs.timeout }})..."
        argocd app wait ${{ inputs.app-name }} \
          --health \
          --timeout ${{ inputs.timeout }}

        echo "âœ… Application synced and healthy"

    - name: Get application status
      if: always()
      shell: bash
      env:
        ARGOCD_SERVER: ${{ inputs.argocd-server }}
        ARGOCD_AUTH_TOKEN: ${{ inputs.argocd-token }}
        ARGOCD_OPTS: "--plaintext"
      run: |
        # Get ArgoCD Application status after sync
        echo "Application status:"
        argocd app get ${{ inputs.app-name }}
