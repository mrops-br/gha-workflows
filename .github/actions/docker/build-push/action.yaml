name: Docker Build and Push
description: Build, tag, and push Docker image with metadata, SBOM, and provenance (Git Flow aware)

inputs:
  context:
    description: 'Build context directory'
    required: false
    default: '.'
  dockerfile:
    description: 'Path to Dockerfile'
    required: false
    default: 'Dockerfile'
  registry:
    description: 'Container registry (e.g., ghcr.io)'
    required: true
  image-name:
    description: 'Image name (without registry prefix, e.g., org/app)'
    required: true
  tags:
    description: 'Custom tags (comma-separated, optional - will use Git Flow tags if empty)'
    required: false
    default: ''
  push:
    description: 'Whether to push the image'
    required: false
    default: 'false'
  platforms:
    description: 'Target platforms (comma-separated)'
    required: false
    default: 'linux/amd64'
  build-args:
    description: 'Build arguments (multiline)'
    required: false
    default: ''
  buildx-driver:
    description: 'Buildx driver (docker-container, remote, or empty for default)'
    required: false
    default: 'remote'
  buildx-endpoint:
    description: 'Buildx remote endpoint (only for remote driver)'
    required: false
    default: 'tcp://buildkitd.github-systems.svc.cluster.local:1234'
  cache-from:
    description: 'Cache sources (e.g., type=gha)'
    required: false
    default: 'type=gha'
  cache-to:
    description: 'Cache destinations (e.g., type=gha,mode=max)'
    required: false
    default: 'type=gha,mode=max'
  enable-sbom:
    description: 'Enable SBOM generation'
    required: false
    default: 'true'
  enable-provenance:
    description: 'Enable provenance attestation'
    required: false
    default: 'true'
  registry-username:
    description: 'Registry username (defaults to github.actor)'
    required: false
    default: ''
  registry-password:
    description: 'Registry password or token'
    required: false
    default: ''

outputs:
  digest:
    description: 'Image digest'
    value: ${{ steps.build.outputs.digest }}
  tags:
    description: 'Image tags (newline-separated)'
    value: ${{ steps.meta.outputs.tags }}
  tags-csv:
    description: 'Image tags (comma-separated)'
    value: ${{ steps.format.outputs.tags-csv }}
  image-ref:
    description: 'Full image reference with digest'
    value: ${{ inputs.registry }}/${{ inputs.image-name }}@${{ steps.build.outputs.digest }}
  metadata:
    description: 'Build metadata JSON'
    value: ${{ steps.build.outputs.metadata }}

runs:
  using: composite
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: ${{ inputs.buildx-driver }}
        endpoint: ${{ inputs.buildx-driver == 'remote' && inputs.buildx-endpoint || '' }}

    - name: Log in to Container Registry
      if: inputs.push == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username || github.actor }}
        password: ${{ inputs.registry-password }}

    - name: Detect Git Flow tags
      id: gitflow
      if: inputs.tags == ''
      uses: mrops-br/gha-workflows/.github/actions/gitflow/detect-version@main
      with:
        branch: ''

    - name: Generate tags with Git Flow
      id: gitflow-tags
      if: inputs.tags == ''
      uses: mrops-br/gha-workflows/.github/actions/gitflow/generate-tags@main
      with:
        branch-type: ${{ steps.gitflow.outputs.branch-type }}
        version: ${{ steps.gitflow.outputs.version }}
        sha: ${{ github.sha }}
        event-name: ${{ github.event_name }}
        pr-number: ${{ github.event.pull_request.number }}

    - name: Prepare tags for metadata action
      id: prepare-tags
      shell: bash
      run: |
        if [ -n "${{ inputs.tags }}" ]; then
          # Use custom tags
          TAGS="${{ inputs.tags }}"
          echo "Using custom tags: $TAGS"
        else
          # Use Git Flow generated tags
          TAGS="${{ steps.gitflow-tags.outputs.tags }}"
          echo "Using Git Flow tags: $TAGS"
        fi

        # Convert comma-separated to newline-separated for metadata action
        TAGS_NL=$(echo "$TAGS" | tr ',' '\n')

        # Build full image references
        FULL_TAGS=""
        for tag in $(echo "$TAGS" | tr ',' ' '); do
          FULL_TAGS="${FULL_TAGS}type=raw,value=${tag}"$'\n'
        done

        echo "tags-input<<EOF" >> $GITHUB_OUTPUT
        echo "$FULL_TAGS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ inputs.registry }}/${{ inputs.image-name }}
        flavor: |
          latest=false
        tags: ${{ steps.prepare-tags.outputs.tags-input }}

    - name: Build and push
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        push: ${{ inputs.push }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: ${{ inputs.platforms }}
        cache-from: ${{ inputs.cache-from }}
        cache-to: ${{ inputs.cache-to }}
        provenance: ${{ inputs.enable-provenance }}
        sbom: ${{ inputs.enable-sbom }}
        build-args: ${{ inputs.build-args }}

    - name: Format outputs
      id: format
      shell: bash
      run: |
        # Convert tags to CSV format
        TAGS_CSV=$(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ',' | sed 's/,$//')
        echo "tags-csv=$TAGS_CSV" >> $GITHUB_OUTPUT

    - name: Generate build summary
      shell: bash
      run: |
        echo "### Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ inputs.registry }}/${{ inputs.image-name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Digest**: \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Pushed**: ${{ inputs.push }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
