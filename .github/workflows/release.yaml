name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  extract-version:
    name: Extract Version
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 10

      - name: Extract version from merge commit
        id: version
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Try to extract from "Merge branch 'release/X.Y.Z'" or "Merge pull request ... from .../release/X.Y.Z"
          if [[ "$COMMIT_MSG" =~ release/([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "Detected release version: $VERSION"
          elif [[ "$COMMIT_MSG" =~ hotfix/([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "Detected hotfix version: $VERSION"
          else
            echo "âŒ Could not extract version from commit message"
            echo "This workflow should only run when merging release/* or hotfix/* to main"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

  update-changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    needs: extract-version
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate changelog with git-cliff
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --verbose --tag v${{ github.event_name == 'push' && needs.extract-version.outputs.version || inputs.version }}
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push changelog
        run: |
          VERSION="${{ github.event_name == 'push' && needs.extract-version.outputs.version || inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md

          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to CHANGELOG.md"
          else
            git commit -m "docs: update CHANGELOG.md for v${VERSION}"
            git push origin main
            echo "âœ… Updated CHANGELOG.md for v${VERSION}"
          fi

  create-git-tag:
    name: Create Git Tag
    runs-on: ubuntu-latest
    needs: [extract-version, update-changelog]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create and push tag
        run: |
          VERSION="${{ github.event_name == 'push' && needs.extract-version.outputs.version || inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "v${VERSION}" -m "Release version ${VERSION}"
          git push origin "v${VERSION}"
          echo "âœ… Created and pushed tag: v${VERSION}"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [extract-version, update-changelog, create-git-tag]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ github.event_name == 'push' && needs.extract-version.outputs.version || inputs.version }}"

          # Extract the section for this version from CHANGELOG.md
          awk "/## \[${VERSION}\]/,/## \[/" CHANGELOG.md | sed '1d;$d' > release-notes.md

          if [ -s release-notes.md ]; then
            echo "âœ… Extracted changelog for v${VERSION}"
            cat release-notes.md
          else
            echo "âš ï¸ No changelog found for v${VERSION}, using default message"
            echo "Release version ${VERSION}" > release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event_name == 'push' && needs.extract-version.outputs.version || inputs.version }}
          name: v${{ github.event_name == 'push' && needs.extract-version.outputs.version || inputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true

  merge-to-develop:
    name: Merge main to develop
    runs-on: ubuntu-latest
    needs: [extract-version, update-changelog, create-git-tag, create-github-release]
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: develop
          fetch-depth: 0

      - name: Merge main into develop
        run: |
          VERSION="${{ needs.extract-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Merging main into develop..."
          git merge origin/main -m "chore: merge main into develop after release v${VERSION}"
          git push origin develop
          echo "âœ… Successfully merged main into develop"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [extract-version, update-changelog, create-git-tag, create-github-release, merge-to-develop]
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ github.event_name == 'push' && needs.extract-version.outputs.version || inputs.version }}"

          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Changelog Update | ${{ needs.update-changelog.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Git Tag | ${{ needs.create-git-tag.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create GitHub Release | ${{ needs.create-github-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge to develop | ${{ needs.merge-to-develop.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.update-changelog.result }}" == "success" && \
                "${{ needs.create-git-tag.result }}" == "success" && \
                "${{ needs.create-github-release.result }}" == "success" && \
                "${{ needs.merge-to-develop.result }}" == "success" ]]; then
            echo "âœ… Release v${VERSION} completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Released Artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) updated" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ·ï¸ Git tag: [\`v${VERSION}\`](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${VERSION}) created" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”€ Merged back to develop" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Release failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
