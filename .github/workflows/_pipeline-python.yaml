name: Pipeline - Python Application

on:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name'
        required: true
        type: string
      image-name:
        description: 'Full container image name (e.g., org/app-name)'
        required: true
        type: string
      project-name:
        description: 'Project name (e.g., devportal)'
        required: true
        type: string
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      package-manager:
        description: 'Package manager (pip, poetry, pipenv)'
        required: false
        type: string
        default: 'pip'
      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'ghcr.io'
      enable-lint:
        description: 'Enable linting'
        required: false
        type: boolean
        default: true
      enable-type-check:
        description: 'Enable type checking'
        required: false
        type: boolean
        default: true
      enable-test:
        description: 'Enable testing'
        required: false
        type: boolean
        default: true
      enable-coverage:
        description: 'Enable coverage reporting'
        required: false
        type: boolean
        default: true
      enable-lint-dockerfile:
        description: 'Enable Dockerfile linting'
        required: false
        type: boolean
        default: true
      dockerfile-failure-threshold:
        description: 'Dockerfile lint failure threshold'
        required: false
        type: string
        default: 'warning'
      deploy-environment:
        description: 'Environment to deploy (auto-detected if not set)'
        required: false
        type: string
        default: ''
      lint-runner:
        description: 'Runner for lint and CI jobs'
        required: false
        type: string
        default: 'ubuntu-latest'
      build-runner:
        description: 'Runner for build and deploy jobs'
        required: false
        type: string
        default: 'shared-runners'
    secrets:
      ARGOCD_AUTH_TOKEN:
        description: 'ArgoCD authentication token'
        required: true
      ARGOCD_SERVER:
        description: 'ArgoCD server URL'
        required: true
      CICD_USERNAME:
        description: 'Container registry username for pulling runner image'
        required: true
      CICD_TOKEN:
        description: 'Container registry token for pulling runner image'
        required: true

jobs:
  # Step 1: Lint Dockerfile
  lint:
    name: Lint Dockerfile
    if: inputs.enable-lint-dockerfile
    runs-on: ${{ inputs.lint-runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Lint Dockerfile
        uses: mrops-br/gha-workflows/.github/actions/quality/lint-dockerfile@main
        with:
          dockerfile: ${{ inputs.dockerfile }}
          failure-threshold: ${{ inputs.dockerfile-failure-threshold }}

  # Step 2: CI - Lint, Test, Security Scan
  ci:
    name: CI
    uses: mrops-br/gha-workflows/.github/workflows/_ci-python.yaml@main
    with:
      python-version: ${{ inputs.python-version }}
      package-manager: ${{ inputs.package-manager }}
      working-directory: ${{ inputs.working-directory }}
      enable-lint: ${{ inputs.enable-lint }}
      enable-type-check: ${{ inputs.enable-type-check }}
      enable-test: ${{ inputs.enable-test }}
      enable-coverage: ${{ inputs.enable-coverage }}
      enable-security-scan: true
      runner: ${{ inputs.lint-runner }}

  # Step 3: Build Docker Image
  build:
    name: Build
    needs: [lint, ci]
    if: |
      always() &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      needs.ci.result == 'success'
    uses: mrops-br/gha-workflows/.github/workflows/_build-docker.yaml@main
    with:
      image-name: ${{ inputs.image-name }}
      context: ${{ inputs.working-directory }}
      dockerfile: ${{ inputs.dockerfile }}
      registry: ${{ inputs.registry }}
      platforms: 'linux/amd64'
      push: ${{ github.event_name != 'pull_request' }}
      runner: ${{ inputs.build-runner }}
    secrets: inherit

  # Step 4: Determine environment
  determine-env:
    name: Determine Environment
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should-deploy: ${{ steps.env.outputs.should-deploy }}
      image-tag: ${{ steps.env.outputs.image-tag }}
    steps:
      - name: Determine deployment environment
        id: env
        run: |
          # Use input if provided, otherwise auto-detect
          if [ -n "${{ inputs.deploy-environment }}" ]; then
            ENV="${{ inputs.deploy-environment }}"
            SHOULD_DEPLOY="true"
            IMAGE_TAG="${{ needs.build.outputs.image-tags }}"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            ENV="dev"
            SHOULD_DEPLOY="true"
            IMAGE_TAG="dev-latest"
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release/ ]]; then
            ENV="stg"
            SHOULD_DEPLOY="true"
            # Extract version tag from build outputs
            IMAGE_TAG=$(echo "${{ needs.build.outputs.image-tags }}" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+-rc' | head -1)
            if [ -z "$IMAGE_TAG" ]; then
              IMAGE_TAG="${{ github.sha }}"
            fi
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV="prd"
            SHOULD_DEPLOY="false"  # Require manual approval for production
            IMAGE_TAG="latest"
          else
            ENV=""
            SHOULD_DEPLOY="false"
            IMAGE_TAG=""
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "Environment: $ENV"
          echo "Should Deploy: $SHOULD_DEPLOY"
          echo "Image Tag: $IMAGE_TAG"

  # Step 5: Deploy to Environment
  deploy:
    name: Deploy to ${{ needs.determine-env.outputs.environment }}
    needs: [build, determine-env]
    if: needs.determine-env.outputs.should-deploy == 'true'
    uses: mrops-br/gha-workflows/.github/workflows/_deploy-argocd.yaml@main
    with:
      app-name: ${{ inputs.app-name }}
      argocd-app-name: ${{ inputs.project-name }}-${{ needs.determine-env.outputs.environment }}-${{ inputs.app-name }}
      image-name: ${{ inputs.image-name }}
      environment: ${{ needs.determine-env.outputs.environment }}
      gitops-repo: ${{ github.repository_owner }}/gitops-${{ inputs.project-name }}
      image-tag: ${{ needs.determine-env.outputs.image-tag }}
      registry: ${{ inputs.registry }}
      wait-for-sync: true
      runner: ${{ inputs.build-runner }}
    secrets:
      ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
      CICD_USERNAME: ${{ secrets.CICD_USERNAME }}
      CICD_TOKEN: ${{ secrets.CICD_TOKEN }}
