name: Pipeline - Node.js Application
description: Complete CI/CD pipeline for Node.js applications with Git Flow support

on:
  workflow_call:
    inputs:
      # Application configuration
      app-name:
        description: 'Application name'
        required: true
        type: string
      image-name:
        description: 'Full container image name (e.g., org/app-name)'
        required: true
        type: string
      project-name:
        description: 'Project name (e.g., devportal)'
        required: true
        type: string

      # Node.js configuration
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      package-manager:
        description: 'Package manager (npm, yarn, pnpm)'
        required: false
        type: string
        default: 'npm'

      # Build configuration
      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'ghcr.io'

      # CI options
      enable-lint:
        description: 'Enable linting'
        required: false
        type: boolean
        default: true
      enable-test:
        description: 'Enable testing'
        required: false
        type: boolean
        default: true
      enable-coverage:
        description: 'Enable coverage reporting'
        required: false
        type: boolean
        default: true
      enable-lint-dockerfile:
        description: 'Enable Dockerfile linting'
        required: false
        type: boolean
        default: true
      dockerfile-failure-threshold:
        description: 'Dockerfile lint failure threshold'
        required: false
        type: string
        default: 'warning'

      # Deployment override
      deploy-environment:
        description: 'Environment to deploy (auto-detected if not set)'
        required: false
        type: string
        default: ''

      # Runners
      lint-runner:
        description: 'Runner for lint and CI jobs'
        required: false
        type: string
        default: 'ubuntu-latest'
      build-runner:
        description: 'Runner for build and deploy jobs'
        required: false
        type: string
        default: 'shared-runners'

    secrets:
      ARGOCD_AUTH_TOKEN:
        description: 'ArgoCD authentication token'
        required: false
      ARGOCD_SERVER:
        description: 'ArgoCD server URL'
        required: false
      CICD_USERNAME:
        description: 'Container registry username for pulling runner image'
        required: false
      CICD_TOKEN:
        description: 'Container registry token for pulling runner image'
        required: false

jobs:
  # Step 1: Lint Dockerfile
  lint:
    name: Lint Dockerfile
    if: inputs.enable-lint-dockerfile
    runs-on: ${{ inputs.lint-runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Lint Dockerfile
        uses: mrops-br/gha-workflows/.github/actions/quality/lint-dockerfile@main
        with:
          dockerfile: ${{ inputs.dockerfile }}
          failure-threshold: ${{ inputs.dockerfile-failure-threshold }}

  # Step 2: Detect Git Flow context
  detect-gitflow:
    name: Detect Git Flow
    uses: mrops-br/gha-workflows/.github/workflows/_detect-gitflow.yaml@main
    with:
      runner: ubuntu-latest

  # Step 3: CI - Lint, Test, Security Scan
  ci:
    name: CI
    uses: mrops-br/gha-workflows/.github/workflows/_ci-nodejs.yaml@main
    with:
      node-version: ${{ inputs.node-version }}
      package-manager: ${{ inputs.package-manager }}
      working-directory: ${{ inputs.working-directory }}
      enable-lint: ${{ inputs.enable-lint }}
      enable-test: ${{ inputs.enable-test }}
      enable-coverage: ${{ inputs.enable-coverage }}
      enable-security-scan: true
      runner: ${{ inputs.lint-runner }}

  # Step 4: Build Docker Image
  build:
    name: Build
    needs: [lint, detect-gitflow, ci]
    if: |
      always() &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      needs.ci.result == 'success'
    uses: mrops-br/gha-workflows/.github/workflows/_build-docker.yaml@main
    with:
      image-name: ${{ inputs.image-name }}
      context: ${{ inputs.working-directory }}
      dockerfile: ${{ inputs.dockerfile }}
      registry: ${{ inputs.registry }}
      platforms: 'linux/amd64'
      push: ${{ github.event_name != 'pull_request' }}
      runner: ${{ inputs.build-runner }}
    secrets: inherit

  # Step 5: Determine deployment environment
  determine-env:
    name: Determine Environment
    needs: [detect-gitflow, build]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should-deploy: ${{ steps.env.outputs.should-deploy }}
      image-tag: ${{ steps.tags.outputs.image-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect environment
        id: env
        uses: mrops-br/gha-workflows/.github/actions/gitflow/detect-env@main
        with:
          branch-type: ${{ needs.detect-gitflow.outputs.branch-type }}
          override-env: ${{ inputs.deploy-environment }}

      - name: Determine image tag
        id: tags
        uses: mrops-br/gha-workflows/.github/actions/gitflow/generate-tags@main
        with:
          branch-type: ${{ needs.detect-gitflow.outputs.branch-type }}
          version: ${{ needs.detect-gitflow.outputs.version }}
          sha: ${{ github.sha }}
          event-name: ${{ github.event_name }}
          pr-number: ${{ github.event.pull_request.number }}

  # Step 6: Deploy to Environment
  deploy:
    name: Deploy to ${{ needs.determine-env.outputs.environment }}
    needs: [build, determine-env]
    if: needs.determine-env.outputs.should-deploy == 'true'
    uses: mrops-br/gha-workflows/.github/workflows/_deploy-argocd.yaml@main
    with:
      app-name: ${{ inputs.app-name }}
      argocd-app-name: ${{ inputs.project-name }}-${{ needs.determine-env.outputs.environment }}-${{ inputs.app-name }}
      image-name: ${{ inputs.image-name }}
      environment: ${{ needs.determine-env.outputs.environment }}
      gitops-repo: ${{ github.repository_owner }}/gitops-${{ inputs.project-name }}
      image-tag: ${{ needs.determine-env.outputs.image-tag }}
      registry: ${{ inputs.registry }}
      wait-for-sync: true
      runner: ${{ inputs.build-runner }}
    secrets:
      ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
      CICD_USERNAME: ${{ secrets.CICD_USERNAME }}
      CICD_TOKEN: ${{ secrets.CICD_TOKEN }}

  # Summary
  summary:
    name: Pipeline Summary
    needs: [lint, detect-gitflow, ci, build, determine-env, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App**: \`${{ inputs.app-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Type**: ${{ needs.detect-gitflow.outputs.branch-type }}" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ needs.detect-gitflow.outputs.version }}" ] && echo "**Version**: ${{ needs.detect-gitflow.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CI | ${{ needs.ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Deployed to \`${{ needs.determine-env.outputs.environment }}\`**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy.result }}" == "skipped" ]] && [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Build completed (deployment skipped)**" >> $GITHUB_STEP_SUMMARY
          fi
